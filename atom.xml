<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Feed Name</title>
  <link href="http://domain/"/>
  <link type="application/atom+xml" rel="self" href="http://domain/atom.xml"/>
  <updated>2016-08-14T14:24:41.0017634+10:00</updated>
  <id>http://domain/</id>
  <author>
    <name>Author</name>
    <email>Email</email>
  </author>

  
  <entry>
    <id>http://domain//technology/2016/08/14/sql-server-locking-parent-tables.html</id>
    <link type="text/html" rel="alternate" href="http://domain//technology/2016/08/14/sql-server-locking-parent-tables.html"/>
    <title>SQL Server: Locking Parent Tables</title>
    <updated>2016-08-14T00:00:00+10:00</updated>
    <author>
      <name>Author</name>
      <uri>http://domain/</uri>
    </author>
    <content type="html">&lt;p&gt;A while back I came across a problem a concurrency issue at work that took several iterations to determine an appropriate fix for. The basic problem was that we had a table representing a parent entity and a dependent child entity. The child entity had an integer column to specify the sort ordering of the children within the parent. For a more concrete example imagine a photo management application. You may have a gallery entity (the parent) which contains a list of photos (the child entity) which can be re-arranged by the user.&lt;/p&gt;
&lt;p&gt;For the sake of simplicity we&apos;ll strip down a lot of the properties on these entities to the bare essentials required for our example.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;CREATE TABLE Gallery (
    Id INTEGER IDENTITY(1,1) PRIMARY KEY,
    Name VARCHAR(50) NOT NULL
)

CREATE TABLE Photo (
    Id INTEGER IDENTITY(1, 1) PRIMARY KEY,
    Name VARCHAR(50) NOT NULL,
    GalleryId INT NOT NULL,
    SortOrder INT NOT NULL,
    CONSTRAINT FK_Photo_GalleryId_Gallery_Id FOREIGN KEY (GalleryId) REFERENCES Gallery (Id)
)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let&apos;s populate the tables with some sample data;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;SET IDENTITY_INSERT Gallery ON
INSERT INTO Gallery (Id, Name) VALUES (1, &apos;Ski trip&apos;)
SET IDENTITY_INSERT Gallery OFF

SET IDENTITY_INSERT Photo ON  
INSERT INTO Photo (Id, Name, GalleryId, SortOrder) VALUES (1, &apos;Me falling over&apos;, 1, 0)
INSERT INTO Photo (Id, Name, GalleryId, SortOrder) VALUES (2, &apos;Me falling over... again&apos;, 1, 1)
INSERT INTO Photo (Id, Name, GalleryId, SortOrder) VALUES (3, &apos;Still falling over...&apos;, 1, 2)
SET IDENTITY_INSERT Photo OFF
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You can imagine a simple query to retrieve the &lt;code&gt;Photo&lt;/code&gt;s in a &lt;code&gt;Gallery&lt;/code&gt; as being something like;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;DECLARE @GalleryId INT = 1

SELECT  P.*
FROM    Photo P
WHERE   P.GalleryId = @GalleryId
ORDER
BY      P.SortOrder
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Pretty simple stuff. To be honest we don&apos;t really care if the first &lt;code&gt;Photo&lt;/code&gt; in a gallery has a &lt;code&gt;SortOrder&lt;/code&gt; of 0 or 10 or -20. As long as its value is less than the second &lt;code&gt;Photo&lt;/code&gt;&apos;s &lt;code&gt;SortOrder&lt;/code&gt; every thing is fine. So all we need to do is when we insert a new &lt;code&gt;Photo&lt;/code&gt; we insert it with a value greater than any other &lt;code&gt;Photo&lt;/code&gt;. Great! Let&apos;s have a crack at writing an &lt;code&gt;INSERT&lt;/code&gt; for this scenario;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;BEGIN TRAN

DECLARE @Name VARCHAR(50) = &apos;A new photo of me falling over&apos;,
        @GalleryId INT = 1,
        @SortOrder INT = NULL

SELECT  @SortOrder = MAX(P.SortOrder) + 1
FROM    Photo P
WHERE   P.GalleryId = @GalleryId

SELECT  @SortOrder = ISNULL(@SortOrder, 0)

INSERT INTO Photo (
        Name,
        GalleryId,
        SortOrder
)
SELECT  @Name,
        @GalleryId,
        @SortOrder

COMMIT TRAN
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The determination of &lt;code&gt;@SortOrder&lt;/code&gt; here is a little contrived. In an actual solution you could move the standalone &lt;code&gt;SELECT&lt;/code&gt; into a sub-&lt;code&gt;SELECT&lt;/code&gt; on the &lt;code&gt;INSERT&lt;/code&gt; statement but let&apos;s just imagine that there&apos;s a constraint that requires this explicit separation. You launch the feature and after a few weeks you review the data and you notice a puzzling thing you&apos;re seeing instances where for a given &lt;code&gt;Photo.GalleryId&lt;/code&gt; there&apos;s multiple items where &lt;code&gt;Photo.SortOrder&lt;/code&gt; is duplicated. After some analysis it should be obvious what&apos;s happening; one &lt;code&gt;Photo&lt;/code&gt; is attempting to get inserted and before it can complete a second &lt;code&gt;Photo&lt;/code&gt; insertion attempt happens and evaluates &lt;code&gt;@SortOrder&lt;/code&gt; to be the same as the first.&lt;/p&gt;
&lt;p&gt;I&apos;ve written previously about &lt;a href=&quot;/technology/2015/09/06/sql-server-tricks.html&quot;&gt;WAITFOR&lt;/a&gt; and how useful it is for debugging concurrency issues. So we&apos;ll use it again here. We can chuck a &lt;code&gt;WAITFOR DELAY 00:00:05&lt;/code&gt; before our &lt;code&gt;INSERT&lt;/code&gt; statement and execute the statement multiple times to simulate this concurrency in human-doable-times. As below...&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;BEGIN TRAN

DECLARE @Name VARCHAR(50) = &apos;A second new photo of me falling over&apos;,
        @GalleryId INT = 1,
        @SortOrder INT = NULL

SELECT  @SortOrder = MAX(P.SortOrder) + 1
FROM    Photo P
WHERE   P.GalleryId = @GalleryId

SELECT  @SortOrder = ISNULL(@SortOrder, 0)

WAITFOR DELAY &apos;00:00:05&apos;

INSERT INTO Photo (
        Name,
        GalleryId,
        SortOrder
)
SELECT  @Name,
        @GalleryId,
        @SortOrder

COMMIT TRAN

SELECT  *
FROM    Photo 
WHERE   GalleryId = @GalleryId
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;What we&apos;re going to do is run this statement twice. Once with the &lt;code&gt;WAITFOR&lt;/code&gt; and once without. You want to run the statement with the &lt;code&gt;WAITFOR&lt;/code&gt; and then wait a second or two before running the version without the &lt;code&gt;WAITFOR&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2016-08-14-sql-server-locking-parent-tables/insert-query-duplicate-results.png&quot; alt=&quot;Insert Spurious Data&quot; title=&quot;Insert Spurious Data&quot; /&gt;&lt;/p&gt;
&lt;p&gt;In this example I&apos;ve ran the statement on the left handside, waited a second or two, and then ran the statement on the right hand side. You can see the left hand side results shows the two &lt;code&gt;Photo&lt;/code&gt; entities with a &lt;code&gt;SortOrder&lt;/code&gt; of 3. Not what we want. What we need to do is take a lock on &lt;code&gt;Photo&lt;/code&gt; of some kind so that concurrent statements are blocked until this statement returns. We don&apos;t want a &lt;code&gt;TABLOCK&lt;/code&gt; or &lt;code&gt;TABLOCKX&lt;/code&gt; as those are too coarse grained. We can instead try an &lt;a href=&quot;https://msdn.microsoft.com/en-us/library/ms187373.aspx&quot;&gt;UPDLOCK&lt;/a&gt; which takes a lock until the entire transaction competes (not just the statement). Let&apos;s update our insertion statement appropriately...&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;BEGIN TRAN

DECLARE @Name VARCHAR(50) = &apos;A second new photo of me falling over&apos;,
        @GalleryId INT = 1,
        @SortOrder INT = NULL

SELECT  @SortOrder = MAX(P.SortOrder) + 1
FROM    Photo P (UPDLOCK)
WHERE   P.GalleryId = @GalleryId

SELECT  @SortOrder = ISNULL(@SortOrder, 0)

WAITFOR DELAY &apos;00:00:05&apos;

INSERT INTO Photo (
        Name,
        GalleryId,
        SortOrder
)
SELECT  @Name,
        @GalleryId,
        @SortOrder

COMMIT TRAN

SELECT  *
FROM    Photo 
WHERE   GalleryId = @GalleryId
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we&apos;ll re-run our two statements side by side again (I&apos;ve truncated the &lt;code&gt;Photo&lt;/code&gt; table and re-inserted the initial data)&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2016-08-14-sql-server-locking-parent-tables/insert-query-updlock.png&quot; alt=&quot;Insert with UPDLOCK&quot; title=&quot;Insert with UPDLOCK&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Hooray! We now get the correct results; all items have unique &lt;code&gt;Photo.SortOrder&lt;/code&gt; values. As per before the left hand side query was executed and then, a few seconds later, I executed the right hand side. One thing to note here is that, as I mentioned, the UPDLOCK takes the lock until the transaction completes. As such the right hand side now takes 3 seconds to complete (as it has to wait for the left hand side&apos;s &lt;code&gt;WAITFOR&lt;/code&gt;). At this stage you&apos;re probably pretty pleased with yourself. So you quickly patch the feature, roll it to production, and pat yourself on the back.&lt;/p&gt;
&lt;p&gt;A few weeks pass someone notices that, again, there&apos;s duplicate &lt;code&gt;Photo.SortOrder&lt;/code&gt; values for a given &lt;code&gt;Photo.GalleryId&lt;/code&gt;. But we just fixed this! Upon further investigation you notice that the duplicate values are always zero. That&apos;s... interesting you think. Why would that be the case? They duplicate values are always zero so it&apos;s probably something to do with a new &lt;code&gt;Gallery&lt;/code&gt;. Let&apos;s create a new &lt;code&gt;Gallery&lt;/code&gt;;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;INSERT INTO Gallery (Name) VALUES (&apos;Kittens&apos;)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we&apos;ll re-run our &lt;code&gt;INSERT&lt;/code&gt; statements, with the &lt;code&gt;UPDLOCK&lt;/code&gt;, from earlier. Only now for &lt;code&gt;@GalleryId = 2&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2016-08-14-sql-server-locking-parent-tables/insert-query-updlock-empty-gallery.png&quot; alt=&quot;Insert with UPDLOCK into an empty Gallery&quot; title=&quot;Insert with UPDLOCK into an empty Gallery&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Ahar! We reproduced the issue. We&apos;ve ended up with two &lt;code&gt;Image.SortOrder&lt;/code&gt; values of 0. Looking at this a bit closer you&apos;ll also notice that, like our initial &lt;code&gt;INSERT&lt;/code&gt;, the right hand side in this query has returned immediately. It no longer waits for the left hand side to execute. But there&apos;s an &lt;code&gt;UPDLOCK&lt;/code&gt;! Shouldn&apos;t it be blocking the right hand side query? Well, unfortunately, because there&apos;s no items SQL Server has nothing to actually lock until the transaction completes. This allows the right hand side to execute before the left hand side has inserted the record. We could modify the &lt;code&gt;UPDLOCK&lt;/code&gt; to be a &lt;code&gt;TABLOCK&lt;/code&gt; or &lt;code&gt;TABLOCKX&lt;/code&gt; but then if I&apos;m inserting into Gallery A I&apos;m blocked by someone else inserting into Gallery B which is less than ideal. Unfortunate because this &lt;code&gt;UPDLOCK&lt;/code&gt; version is nice and granular... but it&apos;s no use to us if we have nothing to lock on. Unless... the &lt;code&gt;Photo&lt;/code&gt; always belongs to a &lt;code&gt;Gallery&lt;/code&gt;, right? And it has a foreign key to &lt;code&gt;Gallery&lt;/code&gt; ensuring this is true. Instead of locking the &lt;code&gt;Photo&lt;/code&gt; can we lock the &lt;code&gt;Gallery&lt;/code&gt;? Let&apos;s try...&lt;/p&gt;
&lt;p&gt;First we&apos;ll create a new &lt;code&gt;Gallery&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;INSERT INTO Gallery (Name) VALUES (&apos;Puppies&apos;)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we&apos;ll re-work our &lt;code&gt;INSERT&lt;/code&gt; statement to lock the &lt;code&gt;Gallery&lt;/code&gt;;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;BEGIN TRAN

DECLARE @Name VARCHAR(50) = &apos;A small puppy&apos;,
        @GalleryId INT = 3,
        @SortOrder INT = NULL,
        @Locked BIT = 0

SELECT  @Locked = 1
FROM    Gallery G WITH (UPDLOCK, ROWLOCK)
WHERE   G.Id = @GalleryId

SELECT  @SortOrder = MAX(P.SortOrder) + 1
FROM    Photo P
WHERE   P.GalleryId = @GalleryId

SELECT  @SortOrder = ISNULL(@SortOrder, 0)

WAITFOR DELAY &apos;00:00:05&apos;

INSERT INTO Photo (
        Name,
        GalleryId,
        SortOrder
)
SELECT  @Name,
        @GalleryId,
        @SortOrder

COMMIT TRAN

SELECT  *
FROM    Photo 
WHERE   GalleryId = @GalleryId
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2016-08-14-sql-server-locking-parent-tables/insert-query-gallery-updlock-empty-gallery.png&quot; alt=&quot;Insert with UPDLOCK on Gallery into an empty Gallery&quot; title=&quot;Insert with UPDLOCK on Gallery into an empty Gallery&quot; /&gt;&lt;/p&gt;
&lt;p&gt;And... success! Once again the right hand side has taken a few seconds to execute as it waits for the left hand side to complete before it can acquire the &lt;code&gt;UPDLOCK&lt;/code&gt; on &lt;code&gt;Gallery&lt;/code&gt;. And once again we have unique values of &lt;code&gt;Photo.SortOrder&lt;/code&gt; as we required. We&apos;ve also introduced the &lt;code&gt;ROWLOCK&lt;/code&gt; hint to indicate we only want to lock the rows returned by the &lt;code&gt;SELECT&lt;/code&gt; on &lt;code&gt;Gallery&lt;/code&gt;. Depending on your index applied this shouldn&apos;t be necessary but I&apos;ve not encountered any issues hinting you only want to lock the row. Between these two hints this ensures that whilst the right hand side took several seconds to complete it is only because it was inserting into the same &lt;code&gt;Gallery&lt;/code&gt; as the left hand side. If you were to insert into a different gallery it&apos;d return instantly.&lt;/p&gt;
&lt;p&gt;I&apos;ve been running this style of locking model for several months in a production environment and it has completely removed the data duplication we were experiencing. Whilst there&apos;s other methods you could use to eliminate the source of error this one ended up working for me and is also easy to verify the behaviour.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <id>http://domain//technology/2015/10/06/finding-dominant-colours-in-images.html</id>
    <link type="text/html" rel="alternate" href="http://domain//technology/2015/10/06/finding-dominant-colours-in-images.html"/>
    <title>Finding Dominant Colours in Images</title>
    <updated>2015-10-06T00:00:00+11:00</updated>
    <author>
      <name>Author</name>
      <uri>http://domain/</uri>
    </author>
    <content type="html">&lt;p&gt;A colleague recently shared a link to &lt;a href=&quot;http://charlesleifer.com/blog/using-python-and-k-means-to-find-the-dominant-colors-in-images/&quot;&gt;Charles Leifer&apos;s blog post on finding dominant colours in images&lt;/a&gt; and mentioned it was something he&apos;d like to eventually integrate into our own product at some time. &lt;a href=&quot;https://en.wikipedia.org/wiki/K-means_clustering&quot;&gt;K-Means clustering&lt;/a&gt; is something I have a vague familiarity with but isn&apos;t something I&apos;ve personally implemented before so with a spare day over the weekend I figured I&apos;d give it a shot.&lt;/p&gt;
&lt;p&gt;If you don&apos;t have an background in algorithms reading about K-Means clustering will lead you to all sorts of &lt;a href=&quot;http://stats.stackexchange.com/a/91076&quot;&gt;Greek letters and mathematical symbols&lt;/a&gt; which may be a little confusing but the actual algorithm is surprisingly straight forward. If you just want to dive straight into the code have a look at &lt;a href=&quot;https://github.com/MrMDavidson/code-samples/tree/master/FindDominantColour&quot;&gt;my code samples repository&lt;/a&gt; which has a simple implementation. Otherwise, stick with me.&lt;/p&gt;
&lt;p&gt;If you&apos;re not familiar with this idea it might help to start with a few examples. Below are three examples produced via the code linked above. In each of them the bottom of the image has three colour swatches which are the k means clusters (in this example, k is 3).&lt;/p&gt;
&lt;h2&gt;Examples&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-10-06-finding-dominant-colours-in-images/coffee.png&quot; alt=&quot;Coffee&quot; title=&quot;Coffee&quot; /&gt;
&lt;img src=&quot;/img/posts/2015-10-06-finding-dominant-colours-in-images/rose.png&quot; alt=&quot;Rose&quot; title=&quot;Rose&quot; /&gt;
&lt;img src=&quot;/img/posts/2015-10-06-finding-dominant-colours-in-images/playmobil.png&quot; alt=&quot;Play Mobil&quot; title=&quot;Play Mobil&quot; /&gt;&lt;/p&gt;
&lt;p&gt;I think looking at these three sample images (all from the &lt;a href=&quot;http://www.morguefile.com/&quot;&gt;Morgue File Project&lt;/a&gt; and free for use) highlights some interesting aspects of the algorithm. The coffee and rose images swatches both look like what your, or at least, my expectation of the dominant colours are in these images. The plastic figurine image isn&apos;t what I initially expected and this gets into the difference between perceived dominance and statistical colour dominance. Looking at this image the light and dark grey and the black are indeed the most &lt;em&gt;common&lt;/em&gt; colours in the image but they&apos;re not the one your eyes are drawn to. You immediately notice the blue of the figures shoes and shirt, yellow pants and ginger hair. However the statistical commonality of these colours is rather low (and their variance from each other would mute their affect on the algorithm). If you are looking for something to get this highlight colour out there&apos;s a few things you could do which I&apos;ll discuss later.&lt;/p&gt;
&lt;h2&gt;Algorithm&lt;/h2&gt;
&lt;p&gt;Now the actual algorithm;&lt;/p&gt;
&lt;ol start=&quot;0&quot;&gt;
&lt;li&gt;Collect your data. Here I&apos;m using .Net&apos;s &lt;a href=&quot;https://msdn.microsoft.com/en-us/library/system.drawing.image(v=vs.110).aspx&quot;&gt;&lt;code&gt;Image&lt;/code&gt;&lt;/a&gt; class to load the pixel data&lt;/li&gt;
&lt;li&gt;Determine a set of &lt;code&gt;k&lt;/code&gt; initial clusters for your data&lt;/li&gt;
&lt;li&gt;For each pixel in your image determine the colour&apos;s &lt;a href=&quot;https://en.wikipedia.org/wiki/Euclidean_distance&quot;&gt;Euclidean distance&lt;/a&gt; to its nearest cluster&lt;/li&gt;
&lt;li&gt;Recalculate the centre of each cluster based on the colours in the cluster&lt;/li&gt;
&lt;li&gt;If the centre of any of the clusters changed, clear the clusters and go back to 2.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;0. Collect your data&lt;/h3&gt;
&lt;p&gt;This is pretty straightforward. You want to load all of the pixels colours of your image into memory. If you look at &lt;a href=&quot;https://github.com/MrMDavidson/code-samples/blob/bedb15ed8748af80936f939fc22b12287f8faa11/FindDominantColour/Program.cs#L43&quot;&gt;Program.cs&lt;/a&gt; I&apos;m doing this very naively through a call to &lt;code&gt;Image::GetPixel()&lt;/code&gt;. It&apos;s not terribly performant but you&apos;ll find that the calculation of the k means will likely take much longer than your repeated calls to &lt;code&gt;Image::GetPixel()&lt;/code&gt;. One thing that &lt;em&gt;is&lt;/em&gt; worth optimising however is the amount of data you load; if you&apos;ve taken a quick snapshot with your phone&apos;s 8 MegaPixel camera you&apos;re not going to need all 8 million pixels. It&apos;s worth resizing the image down to something more mangeable. I&apos;ve had good results with images with a maximum dimension of 75pixels but it will depend on the complexity of your images. Full colour photographs will work better with more pixels as compared to simple logos or drawings. A maximum image dimension of 200 pixels seems to be a good balance between results and speed.&lt;/p&gt;
&lt;h3&gt;1. Determine a set of &lt;code&gt;k&lt;/code&gt; initial clusters&lt;/h3&gt;
&lt;p&gt;The first real part of the algorith is to determine your initial &lt;code&gt;k&lt;/code&gt; clusters. Remember that &lt;code&gt;k&lt;/code&gt; is how many dominant colours you want out of your image. There&apos;s two approaches to determining your initial clusters; The Forgy Method and Random Initialisation. Random Initialisation actually yields excellent results in most cases and it&apos;s really easy to implement. You just pick &lt;code&gt;k&lt;/code&gt; random colours from your list. Their positioning in pixel space doesn&apos;t matter (infact you can discard the pixel coordinates completely it&apos;s only colour space you require). Psuedo-C# for this phase is really straight forward;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-cs&quot;&gt;List&amp;lt;Color&amp;gt; colors = GetSourceData();
Random r = new Random();

for (int i = 0; i &amp;lt; k; i++) {
  int index = r.Next(0, colors.Count);
  AddInitialCluster(colors[index]);
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The actual implementation can be found in &lt;a href=&quot;https://github.com/MrMDavidson/code-samples/blob/bedb15ed8748af80936f939fc22b12287f8faa11/FindDominantColour/KMeansClusteringCalculator.cs#L22-L36&quot;&gt;KMeansClusteringCalculator.cs&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;2. Determine Euclidean Distance to nearest Cluster&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Euclidean_distance&quot;&gt;Euclidean distance&lt;/a&gt;, sometimes known as Cartesian or Pythagorean distance, is the square root of the sum of the square differences between vector components. &lt;em&gt;Obviously&lt;/em&gt;. To put this another way we can think of our &lt;code&gt;Color&lt;/code&gt; as representing a point in 3-dimensional colour space (Instead of an X, Y and Z axis we have a Red, Green and Blue axis). So blue would be at position (0, 0, 255) whilst red would be at (255, 0, 0). And the Euclidiean distance between the two could be calculated with;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-cs&quot;&gt;
private double GetEuclideanDistance(Color c1, Color c2) {
    return Math.Sqrt(
        Math.Pow(c1.R - c2.R, 2) + Math.Pow(c1.G - c2.G, 2) + Math.Pow(c1.B - c2.B, 2)
    );
}

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The actual implementation of this can be found in &lt;a href=&quot;https://github.com/MrMDavidson/code-samples/blob/bedb15ed8748af80936f939fc22b12287f8faa11/FindDominantColour/KCluster.cs#L83-L87&quot;&gt;KCluster.cs&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Now that we know how to calculate the Euclidean distance between two colours it&apos;s a simple matter of comparing the distance for each colour to each of our clusters and adding it to the closest one.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-cs&quot;&gt;var clusterList = GetClusterList();

for (Color color in colors) {
    int indexOfNearestCluster = -1;
    double distanceToNearestCluster = double.MaxValue;

    for (int i = 0; i &amp;lt; clusterList.Length; i++) {
        double distance = GetEuclideanDistance(clusterList[i].Centre, color);
        if (distance &amp;lt; nearestCluster) {
            indexOfNearestCluster = i;
            distanceToNearestCluster = distance;
        }
    }
    
    clusterList[indexOfNearestCluster].AddColour(color);
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The important thing to note here is that &lt;code&gt;clusterList&lt;/code&gt; is a list of some kind of data structure which contains the property &lt;code&gt;Centre&lt;/code&gt; which is, for the first pass, the random colour we came up with in Step 1. Over subsequent iterations this value will be updated. So, once we find the nearest cluster we want to add the colour we&apos;re currently working on to that cluster. This is important for our next step. Again, this is only pseudo-C#, and the actual implementation can be found in &lt;a href=&quot;https://github.com/MrMDavidson/code-samples/blob/bedb15ed8748af80936f939fc22b12287f8faa11/FindDominantColour/KMeansClusteringCalculator.cs#L42-L55&quot;&gt;KMeansClusteringCalculator.cs&lt;/a&gt;.&lt;/p&gt;
&lt;h3&gt;3. Recalculate the cluster centre&lt;/h3&gt;
&lt;p&gt;Like calculcating the Euclidean distance this is again something that looks a lot more intimidating than it is. If you look at Wikipedia you&apos;ll see a wonderfully confusing expression;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-10-06-finding-dominant-colours-in-images/update-step.png&quot; alt=&quot;Update Expression&quot; title=&quot;Update Expression&quot; /&gt;&lt;/p&gt;
&lt;p&gt;But this is actually rather straight forward; for each vector component (ie. red, green and blue) you take the average of that colour component in the cluster.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-cs&quot;&gt;
List&amp;lt;Color&amp;gt; colorsInCluster = GetColoursInCluster();
float r = 0;
float g = 0;
float b = 0;

foreach (Color color in coloursInCluster) {
    r += color.R;
    g += color.G;
    b += color.B;
}

Color updatedCentre = Color.FromArgb(
    (int)Math.Round(r / colorsInCluster.Count),
    (int)Math.Round(g / colorsInCluster.Count),
    (int)Math.Round(b / colorsInCluster.Count)
);

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It&apos;s actually really simple. You can find the actual implementation in &lt;a href=&quot;https://github.com/MrMDavidson/code-samples/blob/bedb15ed8748af80936f939fc22b12287f8faa11/FindDominantColour/KCluster.cs#L46-L62&quot;&gt;KCluster.cs&lt;/a&gt;.&lt;/p&gt;
&lt;h3&gt;4. Check for Cluster Centre Changes&lt;/h3&gt;
&lt;p&gt;This is pretty easy, actually, you take the original centre for each cluster and compute its Euclidiean distance to the new centre. If all of the distances between the old and new centres is below some threshold (or zero) you consider the algorithm complete. The new centres for each of your clusters are the dominant colours in your image. However if any of the centres have moved more than the threshold then you need to empty all of the clusters and start again from Step 2. Now however instead of computing each colour&apos;s distance to the randomly selected colour you are instead comparing it to the recalculated cluster centre. You can see this loop in &lt;a href=&quot;https://github.com/MrMDavidson/code-samples/blob/bedb15ed8748af80936f939fc22b12287f8faa11/FindDominantColour/KMeansClusteringCalculator.cs#L39-L65&quot;&gt;KMeansClusteringCalculator.cs&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;Finally...&lt;/h3&gt;
&lt;p&gt;As I mentioned earlier looking at the plastic figurine image the dominant colours aren&apos;t those your eye are immediately drawn to. What you can do here is filter the data you provide for Step 0. The question is what filtering do you provide? In our figurine example the issue is that there&apos;s a lot of blacks, greys and whites all of which are rather boring. So we probably want to filter those colours out. But how? If you simply filter anything that is, for example, RGB(0, 0, 0) out it won&apos;t catch RGB(0, 0, 1) or RGB(1, 1, 1) which most people would percieve as black. What we want is some kind of way of determining the distance a colour is from black, grey and white.... like, say, our Euclidean distance from earlier. You&apos;ll want to play aroud with exact figures but I found that any colour that has a Euclidean distance of more than 200 from solid black and solid white works rather well.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-cs&quot;&gt;
List&amp;lt;Color&amp;gt; filtered = GetSourceData()
                        .Where(c =&amp;gt; (KCluster.EuclideanDistance(c, Color.Black) &amp;gt;= 200) &amp;amp;&amp;amp; (KCluster.EuclideanDistance(c, Color.White) &amp;gt;= 200))
                        .ToList(); 

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After such a filter has been applied you&apos;ll end up with images more like...&lt;/p&gt;
&lt;div class=&quot;container&quot;&gt;
&lt;div class=&quot;row&quot;&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-10-06-finding-dominant-colours-in-images/coffee.png&quot; alt=&quot;Coffee&quot; title=&quot;Coffee&quot; /&gt;
&lt;img src=&quot;/img/posts/2015-10-06-finding-dominant-colours-in-images/coffee.filtered.png&quot; alt=&quot;Coffee - Filtered&quot; title=&quot;Coffee - Filtered&quot; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;row&quot;&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-10-06-finding-dominant-colours-in-images/rose.png&quot; alt=&quot;Rose&quot; title=&quot;Rose&quot; /&gt;
&lt;img src=&quot;/img/posts/2015-10-06-finding-dominant-colours-in-images/rose.filtered.png&quot; alt=&quot;Rose - Filtered&quot; title=&quot;Rose - Filtered&quot; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;row&quot;&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-10-06-finding-dominant-colours-in-images/playmobil.png&quot; alt=&quot;Play Mobil&quot; title=&quot;Play Mobil&quot; /&gt;
&lt;img src=&quot;/img/posts/2015-10-06-finding-dominant-colours-in-images/playmobil.filtered.png&quot; alt=&quot;Play Mobil - Filtered&quot; title=&quot;Play Mobil - Filtered&quot; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;This produces excellent, eye catching, results for our plastic figurine. But notice now the most dominant colour on the coffee is the blue colour from the oil sheen? It&apos;s worthwhile playing with these threshold values to see what produces the appropriate output for your use case.&lt;/p&gt;
&lt;p&gt;All of the source is available in my &lt;a href=&quot;https://github.com/MrMDavidson/code-samples/tree/master/FindDominantColour&quot;&gt;code-samples repository&lt;/a&gt; on GitHub. When running the code you can point it to a single file or a directory full of images. It&apos;ll produce the k means cluster for those images, output to the console, and then produce a &lt;code&gt;.output.png&lt;/code&gt; file which contains the swatches used throughout this post.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <id>http://domain//technology/2015/09/12/the-curse-of-the-evergreen-web.html</id>
    <link type="text/html" rel="alternate" href="http://domain//technology/2015/09/12/the-curse-of-the-evergreen-web.html"/>
    <title>The Curse of the Evergreen Web</title>
    <updated>2015-09-12T00:00:00+10:00</updated>
    <author>
      <name>Author</name>
      <uri>http://domain/</uri>
    </author>
    <content type="html">&lt;p&gt;With the release of Windows 10 Microsoft introduced a new browser, Edge, that promised to free us web developers from having to support IE 12 in 10 years time like we do with IE6 now. Edge is hardly the first browser to introduce constantly updated versions; Firefox and Chrome have been doing this for years. Most users of either of these browsers wouldn&apos;t have a clue what particular version of those browsers they&apos;re on. (Don&apos;t believe me? Quick, talk to a colleague, a friend, a relative and ask them if they&apos;re running Chrome 44 or Chrome 45. I&apos;ll wait...) This is something Scott Hanselman refers to as &lt;a href=&quot;http://www.hanselman.com/blog/TheEvergreenWeb.aspx&quot;&gt;The Evergreen Web&lt;/a&gt;. In the article Scott talks about the importance of compatibility modes and as time progresses they&apos;re going to become more and more important. However when most developers think of browsers and compatibility modes they think rendering engines but I recently stumbled across some behaviour in Chrome 45 that was fundamentally different (and broken) as compared to the behaviour of Chrome 44. It made me realise there&apos;s a curse to the &amp;quot;Evergreen Web&amp;quot; - we developers seem to think it&apos;ll only ever mean things will get better. But humans write software and humans make mistakes. So bugs will ineveitably be introduced into the latest versions of browsers. Bugs that will break existing, well documented, standardised behaviour.&lt;/p&gt;
&lt;p&gt;A little bit of background here; Many years ago the developers of the HTTP specification realised that connection speeds aren&apos;t infinite, that time outs happen, connections drop, and that resources can be large. So they implemented something called range requests and responses. When your browser talks to a server it tells the server &amp;quot;Hey! I want all of this resource!&amp;quot; it does this by using a request header of &lt;code&gt;Range: bytes=0-&lt;/code&gt;. This tells the server that the web browser knows about range requests and it&apos;s currently requesting the range 0 to the end of the file. If the resource is hosted on even a remotely modern web server the server will respond with a slightly different response to normal. For one it will return a response code of &lt;code&gt;206 Partial Content&lt;/code&gt; instead of a standard &lt;code&gt;200 OK&lt;/code&gt; response. Additionally you&apos;ll see headers something like;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Accept-Ranges: bytes
Content-Length: 1234
Content-Range: bytes 0-1233/1234
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This tells the web browser &amp;quot;FYI: I can accept byte ranges! Anyway, this file content is 1234 bytes long. And this response is the range of bytes from 0-1233 (for a length of 1234)!&amp;quot;. The client goes about it&apos;s merry way and starts consuming the response from the server. But, alas, alark, after byte 400 your internet connection dies! A few moments later it comes back up and you try downloading that same file. Instead of requesting the entire thing your browser, knowing that the resource came from a server that supports range requests/responses, will alter the request for the resource. This time when it requests the resource it&apos;ll insert a header &lt;code&gt;Range: bytes=400-1233&lt;/code&gt;. Now when the server receives this it&apos;ll know to skip the first 400 bytes. It&apos;ll respond with another &lt;code&gt;206 Partial Content&lt;/code&gt; response with headers akin to;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Accept-Ranges: bytes
Content-Length: 834
Content-Range: bytes 400-1233/1234
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then your browser knows when re-assembling the file that this response goes on the end of its prior response from the server and voila! You have the entire file without having to request the entire thing again. In our simplistic example we&apos;re talking about saving a few hundred bytes and, well, who cares? But imagine the file wasn&apos;t 1234 bytes. What if it was 100mb? 1,000mb? 4,000mb? And what if you were on a slow connection? Or a connection where you pay for data? It starts to become a pretty useful feature.&lt;/p&gt;
&lt;p&gt;But, that&apos;s not all, this can be combined with other great &amp;quot;modern&amp;quot; features. Let&apos;s say I have an audio file on my webpage. I hear there&apos;s sites out &lt;a href=&quot;http://www.soundcloud.com&quot;&gt;there&lt;/a&gt; that do this kind of craziness. Now I click play on an MP3 but I&apos;ve already heard the first half of it so I skip halfway through the file. A smart browser can look at the response from the server and make an educated guess that if the user has clicked halfway through the MP3 then it can terminate the current request and just request from the halfway point of the file. In fact, I have such an example of this happening...&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-09-12-the-curse-of-the-evergreen-web/chrome-44-206-behaviour.gif&quot; alt=&quot;Soundcloud Partial Response&quot; title=&quot;Partial Responses&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Here I am listening to Australian comedian &lt;a href=&quot;http://www.wilanderson.com.au/&quot;&gt;Wil Anderson&lt;/a&gt;&apos;s podcast &lt;a href=&quot;https://soundcloud.com/tofop&quot;&gt;TOFOP on Soundcloud&lt;/a&gt;. When I hit play my browser (Chrome 44, here) starts downloading and playing the MP3. When I skip to the end of the MP3 it terminates the existing download and starts a new download at my requested position. This is great - I&apos;m not downloading the ~40mb of data inbetween those points that I don&apos;t care about and I hear audio at the new point almost instantly.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-09-12-the-curse-of-the-evergreen-web/chrome-44-initial-request.png&quot; alt=&quot;Soundcloud Initial Request/Response&quot; title=&quot;Initial Request/Response&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Looking through the response details you can see that my browser has indicated that it handles ranges and that the server has responded with a &lt;code&gt;206 Partial Content&lt;/code&gt; and indicated the range that it has served.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-09-12-the-curse-of-the-evergreen-web/chrome-44-subsequent-request.png&quot; alt=&quot;Soundcloud Subsequent Request/Response&quot; title=&quot;Subsequent Request/Response&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Once I click later in the file we can see that my browser has made the second request with a specific &lt;code&gt;Range: bytes=...&lt;/code&gt; request header. The server has responded with the appropriate range.&lt;/p&gt;
&lt;p&gt;Now, what does any of this have to do with the &amp;quot;Evergreen Web&amp;quot; ? Well all of those requests were made whilst I was on Chrome 44. Now let&apos;s try the same thing on Chrome 45.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-09-12-the-curse-of-the-evergreen-web/chrome-45-206-behaviour.gif&quot; alt=&quot;Soundcloud No Partial Responses (FTTP)&quot; title=&quot;No Partial Responses (FTTP)&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Notice now when I through the file that the pause/play button has turned into a spinner? And that there is no termination of the connection and creation of a new request? I&apos;m on a pretty quick connection where I am so it&apos;s not too bad too download the interim ~45mb of data. But it does interupt my listening experience. Let&apos;s just say that instead of being on a Fibre to the Premises connection I was on WiFi...&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-09-12-the-curse-of-the-evergreen-web/chrome-45-wifi-206-behaviour.gif&quot; alt=&quot;Soundcloud No Partial Responses (WiFi)&quot; title=&quot;No Partial Responses (WiFi)&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Here I&apos;ve used Chrome&apos;s bandwidth throttling to simulate a WiFi connection (Still a rather good connection, mind!) and notice how much longer I have to wait before the pause/play button stops spinning? Now imagine I&apos;m on a 3G connection. Or a DSL2 connection (which I tried to show you but my screen recording software actually crashed because it took too long).&lt;/p&gt;
&lt;p&gt;Ignoring the horrible user experience here there&apos;s also a, potential, monetary cost. As a consumer you might be spending additional money (or time) to download that unwanted data. And if you&apos;re hosting resources? Well you just threw those 45mb of data to a client that didn&apos;t even want them. Chrome 45 was only released on the &lt;a href=&quot;https://en.wikipedia.org/wiki/Google_Chrome_release_history&quot;&gt;1st of September&lt;/a&gt; but in those two weeks it already has &lt;a href=&quot;http://gs.statcounter.com/#browser_version-ww-daily-20150901-20150911-bar&quot;&gt;~23.93% of the browser market share&lt;/a&gt;. That&apos;s a lot of users potentially wasting a lot of data.&lt;/p&gt;
&lt;p&gt;I should point out that this problem is, currently, only present in Chrome 45 when dealing with MP3s. It seems to have been done as part of a bug fix that meant that Chrome &amp;lt; 45 required &lt;a href=&quot;https://code.google.com/p/chromium/issues/detail?id=397365&quot;&gt;XING/INFO headers even on CBR MP3s to seek&lt;/a&gt;. For most people this probably isn&apos;t a huge problem but I just spent two days playing around with potential work arounds. The Chrome team&apos;s response to this is that they&apos;ll have it &lt;a href=&quot;https://code.google.com/p/chromium/issues/detail?id=530043#c10&quot;&gt;fixed for Chromium 47&lt;/a&gt;. I&apos;m not 100% sure on the cycle between Chrome and Chromium but Chromium 45 was branched on &lt;a href=&quot;https://www.chromium.org/developers/calendar&quot;&gt;July 10th&lt;/a&gt; and Chrome 45 got released on the &lt;a href=&quot;https://en.wikipedia.org/wiki/Google_Chrome_release_history&quot;&gt;1st of September&lt;/a&gt;. Chromium 47 is scheduled to be branched on &lt;a href=&quot;https://www.chromium.org/developers/calendar&quot;&gt;October 2nd&lt;/a&gt; - if there&apos;s a similar branch to release gap we&apos;ll be living with this bug until December. In the mean time I guess a lot of MP3 bits will be getting streamed to &lt;code&gt;/dev/null&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;It does make me wonder though; if an issue like this is going to take the Chrome team weeks, or months, to fix are we running the risk that people will start to build to these behaviours? Maybe someone, somewhere, uses this feature to force a user to have a degraded experience if they try to skip through an ad. Not the best example but I can definitely envision a point where people build web features utilising the exact behaviour of a browser version. And if  web developers start to rely on features specific to a range of browser versions is it going to become a &lt;a href=&quot;https://en.wikipedia.org/wiki/Quirks_mode&quot;&gt;Quirks Mode&lt;/a&gt; that the browser maintainers have to implement? Is someone one day going to include a &lt;code&gt;&amp;lt;meta&amp;gt;&lt;/code&gt; tag in the &lt;code&gt;&amp;lt;head&amp;gt;&lt;/code&gt; of their document to get newer versions of Chrome to break range requests for MP3 files?&lt;/p&gt;
&lt;p&gt;Until Chrome 47 lands, then, if you want to skip through audio files on the web you have a few options; you can try using AAC files instead, you can use Chrome 44, or you can use another browser.&lt;/p&gt;
&lt;p&gt;Note: If you a developer affected by this and you manage to find a work around please let me know!&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;UPDATE 2015-09-16&lt;/strong&gt;: The Chrome team is now aiming to get this out in time for &lt;a href=&quot;https://code.google.com/p/chromium/issues/detail?id=530043#c15&quot;&gt;Chrome 46&lt;/a&gt;. I still have no exact idea of the timeline of when that will be. But it&apos;s better news than having to wait for 47.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <id>http://domain//technology/2015/09/06/sql-server-tricks.html</id>
    <link type="text/html" rel="alternate" href="http://domain//technology/2015/09/06/sql-server-tricks.html"/>
    <title>SQL Server Tricks</title>
    <updated>2015-09-06T00:00:00+10:00</updated>
    <author>
      <name>Author</name>
      <uri>http://domain/</uri>
    </author>
    <content type="html">&lt;p&gt;Throughout my career I&apos;ve spent more than my fair share of time in the database layer. There&apos;s a current trent in the .Net world of just letting your ORM take care of everything in the data layer for you. I&apos;m a huge proponent of using an ORM for mapping (at work we&apos;re currently using StackExchange&apos;s &lt;a href=&quot;https://github.com/StackExchange/dapper-dot-net&quot;&gt;Dapper.net&lt;/a&gt;). However I&apos;ve always been a little wary of letting the ORM do everything for you. As such I thought I&apos;d jot down a few handy SQL Server tricks I&apos;ve picked up over the years.&lt;/p&gt;
&lt;h3&gt;1. The Output Clause&lt;/h3&gt;
&lt;p&gt;The &lt;a href=&quot;https://msdn.microsoft.com/en-us/library/ms177564.aspx&quot;&gt;&lt;code&gt;OUTPUT&lt;/code&gt; clause&lt;/a&gt; let&apos;s you execute a data modification statement and have it project a result set. In plain English that means that you can perform a &lt;code&gt;DELETE&lt;/code&gt;, &lt;code&gt;INSERT&lt;/code&gt; or &lt;code&gt;UPDATE&lt;/code&gt; &lt;strong&gt;and&lt;/strong&gt; have it return a resultset. This has been around since SQL Server 2008 but doesn&apos;t seem to get much attention. An example might be;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;UPDATE  Customers
SET     Archived = 1
OUTPUT  DELETED.Id,
        DELETED.EmailAddress
WHERE   RecentlyLoggedIn = 0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In one, atomic, operation this would mark all customer who have not recently logged in as archived as well as returning the customer id and email address for all those customers. I&apos;ve seen this often implemented as something along the lines of&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;SELECT  C.Id,
        C.EmailAddress
FROM    Customers C
WHERE   C.RecentlyLoggedIn = 0

UPDATE  Customers
SET     Archived = 1
WHERE   RecentlyLoggedIn = 0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;However, depending on your locking model applied, another process could come along and change the status of &lt;code&gt;RecentlyLoggedIn&lt;/code&gt; between the two statements. This won&apos;t happen with the original statement I provided. It also means that the entire operation can be rolled back as a transactional unit of work.&lt;/p&gt;
&lt;p&gt;It&apos;s worth noting that with the &lt;code&gt;OUTPUT&lt;/code&gt; clause you get access to both an &lt;code&gt;INSERTED&lt;/code&gt; and a &lt;code&gt;DELETED&lt;/code&gt; psuedo-table to operate on. You can think of the &lt;code&gt;INSERTED&lt;/code&gt; table as the &amp;quot;new&amp;quot; view of the data after the operation has finished (Only applicable with &lt;code&gt;UPDATE&lt;/code&gt;, &lt;code&gt;INSERT&lt;/code&gt; and &lt;code&gt;MERGE&lt;/code&gt;) statements and the &lt;code&gt;DELETED&lt;/code&gt; table as the view before the operation was executed (Only applicable with the &lt;code&gt;UPDATE&lt;/code&gt;, &lt;code&gt;DELETE&lt;/code&gt; and &lt;code&gt;MERGE&lt;/code&gt; operation).&lt;/p&gt;
&lt;h3&gt;2. &lt;code&gt;READPAST&lt;/code&gt; and &lt;code&gt;ROWLOCK&lt;/code&gt; locking hints&lt;/h3&gt;
&lt;p&gt;Both of these &lt;a href=&quot;https://msdn.microsoft.com/en-us/library/ms187373.aspx&quot;&gt;locking hints&lt;/a&gt; have been available since SQL Server 2008 and work very well together.&lt;/p&gt;
&lt;p&gt;First the &lt;code&gt;ROWLOCK&lt;/code&gt; hint tells SQL Server to, where possible, use a row level lock instead of a page or table lock. This means that instead of locking an entire table, or index page, SQL Server will minimise the locking to only the affected row(s).&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;UPDATE  Customers WITH (ROWLOCK)
SET     CustomerEmailed = 1
WHERE   Archived = 1
AND     CustomerEmailed = 0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;READPAST&lt;/code&gt;, available since SQL Server 2008, instructs SQL Server that if a row in the dataset has a row level lock applied to skip past it. This can be very handy when performing any kind of queue based work. Suppose we have&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;SELECT  C.Id,
        C.Email
FROM    Customers C WITH (READPAST)
WHERE   Archived = 1
AND     CustomerEmailed = 1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If this was executed whilst the &lt;code&gt;ROWLOCK&lt;/code&gt; example was executing it would only return those rows where &lt;code&gt;Archived = 1&lt;/code&gt; and &lt;code&gt;CustomerEmailed = 1&lt;/code&gt; was true &lt;em&gt;before&lt;/em&gt; the first transaction started executing. It&apos;s important to note that this means that any locked row is completely ignored from the resultset! Let me reiterate that; If a row is currently locked it will not be in the produced output, even though it would (once any locks are released) appear in the resultset. Depending on what you&apos;re doing this is very powerful... but if you&apos;re not aware of it you may introduce subtle, transient, bugs. So be careful.&lt;/p&gt;
&lt;h3&gt;3. &lt;code&gt;RAISERROR ... WITH NOWAIT&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://msdn.microsoft.com/en-us/library/ms178592.aspx&quot;&gt;&lt;code&gt;RAISERROR .. WITH NOWAIT&lt;/code&gt;&lt;/a&gt; let&apos;s you flush a message to SQL Server Management Studio immediately rather than waiting until the end of the batch. This is useful when you&apos;re testing locking to track which statement is causing the execution to block&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;RAISERROR(&apos;Hello world&apos;, 0, 1) WITH NOWAIT
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;4. Testing Locks&lt;/h3&gt;
&lt;p&gt;The final quick tip is how you can test locks. Getting things to run at just the right time can be very tricky and the application of appropriate locking hints is highly dependent on a number of factors (indexes involved, the query analyzer, foreign keys, the statement, etc). So when it comes to testing how locks interact with each other one of the simplest tools is the &lt;a href=&quot;https://msdn.microsoft.com/en-us/library/ms187331.aspx&quot;&gt;&lt;code&gt;WAITFOR DELAY&lt;/code&gt;&lt;/a&gt; expression. This makes SQL Server pause execution of your query until the time elapses. Eg. &lt;code&gt;WAITFOR DELAY &apos;0:00:10&apos;&lt;/code&gt; would wait for 10 seconds to elapse. Using this trick you can construct queries which emulate longer running tasks or concurrent operations.&lt;/p&gt;
&lt;p&gt;To better illustrate all of this we&apos;ll create the simple table used throughout these examples and populate it&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;CREATE TABLE Customers (
    [Id] [int] IDENTITY(1,1) PRIMARY KEY NOT NULL,
    [Email] [varchar](250) NULL,
    [Archived] [bit] NULL,
    [CustomerEmailed] [bit] NULL,
)
GO

INSERT INTO Customers (Email, Archived, CustomerEmailed)
SELECT  &apos;user1@domain.com&apos;, 0, 0
UNION ALL
SELECT  &apos;user2@domain.com&apos;, 1, 1
UNION ALL
SELECT  &apos;user3@domain.com&apos;, 1, 0
UNION ALL
SELECT  &apos;user4@domain.com&apos;, 0, 1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-09-06-sql-server-tricks/sample-data.png&quot; alt=&quot;Sample Data&quot; title=&quot;Sample Data&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Now we&apos;ll run two different queries. The first one mark any customers as emailed that have not yet been emailed but are archived. It&apos;ll then return this recordset to the calling code. You can imagine in an actual application exeucting this statement, looping over the resultset, and emailing the associated customers. To simulate the work of emailing the customer we&apos;ll make use of the &lt;code&gt;WAITFOR... DELAY&lt;/code&gt; statement we mentioned earlier.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;BEGIN TRAN

RAISERROR(&apos;Executing update&apos;, 0, 1) WITH NOWAIT

UPDATE  Customers WITH (ROWLOCK)
SET     CustomerEmailed = 1
OUTPUT  INSERTED.Id,
        INSERTED.Email
WHERE   Archived = 1
AND     CustomerEmailed = 0

RAISERROR(&apos;Update finished&apos;, 0, 1) WITH NOWAIT

WAITFOR DELAY &apos;00:00:10&apos;

RAISERROR(&apos;Work finished&apos;, 0, 1) WITH NOWAIT

ROLLBACK TRAN
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Go ahead and run this. After 10s you&apos;ll get the results. You may not see the actual result sets until the 10s delay has elapsed but if you switch to the &lt;code&gt;Messages&lt;/code&gt; tab instead of the &lt;code&gt;Results&lt;/code&gt; tab you&apos;ll see it straight away printint out the &amp;quot;Executing update&amp;quot; and &amp;quot;Update finished&amp;quot; messages. The second query we&apos;ll execute will select those customers who have been emailed.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-SQL&quot;&gt;BEGIN TRAN

RAISERROR(&apos;Selecting with READPAST&apos;, 0, 1) WITH NOWAIT

SELECT  *
FROM    Customers WITH (READPAST)
WHERE   CustomerEmailed = 1

RAISERROR(&apos;Selecting without READPAST&apos;, 0, 1) WITH NOWAIT

SELECT  *
FROM    Customers
WHERE   CustomerEmailed = 1

RAISERROR(&apos;Executing update&apos;, 0, 1) WITH NOWAIT

ROLLBACK TRAN
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If we execute this at the same time as the first query you will immediately get back the list of customers. And then, once the first query has finished, you&apos;ll get the second resultset. One thing to note is that if the first transaction committed you would get back &lt;strong&gt;3&lt;/strong&gt; customers in the second resultset but still only &lt;strong&gt;2&lt;/strong&gt; customer in the first resultset.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-09-06-sql-server-tricks/running-queries.png&quot; alt=&quot;Whilst executing&quot; title=&quot;Whilst executing&quot; /&gt;
Whilst both queries are executing you&apos;ll see something output something like this. Note that the lefthand side has generated its resultset as has the &lt;code&gt;READPAST&lt;/code&gt; query on the right hand side. But the second resultset on the right hasn&apos;t generated yet.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-09-06-sql-server-tricks/ran-queries.png&quot; alt=&quot;Finished executing&quot; title=&quot;Finished executing&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Once the &lt;code&gt;WAITFOR DELAY&lt;/code&gt; has finished (and any work is committed or rolled back) the second resultset on the right will generate. You can verify that by running &lt;code&gt;sp_who2 &apos;active&apos;&lt;/code&gt; while both are running.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-09-06-sql-server-tricks/blocked-by.png&quot; alt=&quot;sp_who2&quot; title=&quot;Blocked By&quot; /&gt;
Here we can see that the right hand query, SPID 52, is currently blocked by SPID 53, which is the left hand side.&lt;/p&gt;
&lt;p&gt;Hope you find these little tips helpful!&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <id>http://domain//technology/2015/08/31/tags.html</id>
    <link type="text/html" rel="alternate" href="http://domain//technology/2015/08/31/tags.html"/>
    <title>Tags?</title>
    <updated>2015-08-31T00:00:00+10:00</updated>
    <author>
      <name>Author</name>
      <uri>http://domain/</uri>
    </author>
    <content type="html">&lt;p&gt;After doing my initial &lt;a href=&quot;technology/2015/08/30/myfirstpost.html&quot;&gt;post yesterday&lt;/a&gt; I realised it&apos;d be useful to have tags (or categories, whatever your preferred nomenclature) support. It&apos;s an easy way for a user to quickly find everything relating to, say, &lt;a href=&quot;/tag/pretzel&quot;&gt;Pretzel&lt;/a&gt; without having to read about &lt;a href=&quot;/tag/cats&quot;&gt;cats&lt;/a&gt;. How do we go about getting such a feature? Remeember that Pretzel is a static blog engine. Everything is generated offline on your computer and then uploaded to your host (in my case, &lt;a href=&quot;https://pages.github.com&quot;&gt;Github Pages&lt;/a&gt;) so there&apos;s no hitting a database to pull back the relevant files.&lt;/p&gt;
&lt;p&gt;If you investigate a little bit you&apos;ll find that when you&apos;re viewing an individual post the template used to generate the static HTML is &lt;a href=&quot;https://github.com/MrMDavidson/mrmdavidson.github.io/blob/a3b3e198dbecbbe6e86893ab0276963eb694cf70/_layouts/post.html&quot;&gt;_layouts/post.html&lt;/a&gt; which seems to have some code relating to tags;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;{% for tag in page.tags %}
    &amp;lt;li&amp;gt;&amp;lt;a href=&amp;quot;/tag/{{ tag }}&amp;quot;&amp;gt;{{ tag }}&amp;lt;/a&amp;gt;&amp;lt;/li&amp;gt;
{% endfor %}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The default set up has some support for it! Excellent! If you look at the mark down source files for your post you&apos;ll see there&apos;s a block of &lt;a href=&quot;http://yaml.org&quot;&gt;YAML&lt;/a&gt; at the top (actually this is something Jekyll refers to as &lt;a href=&quot;http://jekyllrb.com/docs/frontmatter/&quot;&gt;Front Matter&lt;/a&gt; and is how it determines the file is special and needs processing. Pretzel follows this same convention). We need to add some tags to this block. The Front Matter for this post might be;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-yaml&quot;&gt;---
layout: post
title: &amp;quot;Tags?&amp;quot;
tags: [ pretzel, blog ]
---
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This tells Pretzel that this post has two tags associated with it; &lt;a href=&quot;/tag/pretzel&quot;&gt;Pretzel&lt;/a&gt; and &lt;a href=&quot;/tag/blog&quot;&gt;blog&lt;/a&gt;. Let&apos;s fire up Pretzel and &amp;quot;taste&amp;quot; things...&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-08-31-tags/not-working-tags.png&quot; alt=&quot;Tag Rendering&quot; title=&quot;Tag Rendering&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Success! I&apos;ll just go click on those tag links and...&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-08-31-tags/404-tag-not-found.png&quot; alt=&quot;404, Tag Not Found&quot; title=&quot;Tag Not Found&quot; /&gt;&lt;/p&gt;
&lt;p&gt;I should have known that&apos;d be too easy. If you have a look about the place you&apos;ll find that there&apos;s a plugin for Jekyll to support &lt;a href=&quot;http://jekyllrb.com/docs/plugins/#tags&quot;&gt;tags&lt;/a&gt;. But that&apos;s not that helpful to us. So back to the drawing board. I came across a post on using &lt;a href=&quot;http://www.minddust.com/post/tags-and-categories-on-github-pages/&quot;&gt;tags on Github Pages&lt;/a&gt; - it seems that Github Pages don&apos;t support the tags plugin so Jekyll users are in a similar boat to us. Interesting!&lt;/p&gt;
&lt;p&gt;Going through the steps in the &lt;a href=&quot;http://www.minddust.com/post/tags-and-categories-on-github-pages/&quot;&gt;Minddust post&lt;/a&gt; we can straight away skip the first two - the default Pretzel templates already contain markup for tags. Let&apos;s start with creating a new layout. Create a new file &lt;code&gt;_layouts/posts_by_tag.html&lt;/code&gt; and we&apos;ll copy the content from Minddust;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;h1&amp;gt;Articles by tag :{{ page.tag }}&amp;lt;/h1&amp;gt;
&amp;lt;div&amp;gt;
    {% if site.tags[page.tag] %}
        {% for post in site.tags[page.tag] %}
            &amp;lt;a href=&amp;quot;{{ post.url }}/&amp;quot;&amp;gt;{{ post.title }}&amp;lt;/a&amp;gt;
        {% endfor %}
    {% else %}
        &amp;lt;p&amp;gt;There are no posts for this tag.&amp;lt;/p&amp;gt;
    {% endif %}
&amp;lt;/div&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After a bit of trial and error I found you don&apos;t actually need &lt;code&gt;_data/tags.yml&lt;/code&gt; either so ignore that. We do, however, have to create a template-per-tag. This is where such a method will kind of fall down. If you use lots and lots of tags this is the sort of thing that you are (&lt;em&gt;well, I am, anyhow&lt;/em&gt;) likely to forget. If you do then your readers will get a 404 when they click on a tag that you haven&apos;t &amp;quot;populated&amp;quot; yet. In lieu of a better solution we&apos;ll live with this. Now we&apos;ll create our first tag layout file - for me that&apos;s &lt;code&gt;tag/blog.md&lt;/code&gt;. (Note: The &lt;code&gt;tag&lt;/code&gt; portion is because our URLs will be of the form &lt;code&gt;tag/blog&lt;/code&gt; - if you wanted these to be of the form &lt;code&gt;my-awesome-tags/blog&lt;/code&gt; your &lt;code&gt;blog.md&lt;/code&gt; would instead live in the &lt;code&gt;my-awesome-tags&lt;/code&gt; directory. Jekyll / Pretzel will copy directories from the input to the output unless they start with an underscore).&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-yaml&quot;&gt;---
layout: posts_by_tag
tag: blog
permalink: /tag/blog
---
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Nothing else is needed in our layout file. A couple of notes; the &lt;code&gt;layout&lt;/code&gt; value should be the filename of your layout file, without the path or extension, that you created earlier  (eg. I have &lt;code&gt;_layouts/posts_by_tag.html&lt;/code&gt; so this value is &lt;code&gt;posts_by_tag&lt;/code&gt;). The &lt;code&gt;permalink&lt;/code&gt; tag here just sets the output URL to be used. I want to serve my tag page as &lt;code&gt;/tag/blog&lt;/code&gt; instead of the default &lt;code&gt;/tag/blog.html&lt;/code&gt;.) Now that that&apos;s done let&apos;s test it out!&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-08-31-tags/no-posts-for-tag.png&quot; alt=&quot;No articles?!?&quot; title=&quot;No posts for tag?&quot; /&gt;&lt;/p&gt;
&lt;p&gt;... And apparently I have even fewer blog posts than I thought! The good news is we aren&apos;t getting a 404 anymore. The bad news is... we&apos;re not getting our nice list of posts for the tag. What gives? I did a little digging and it turns out it&apos;s the syntax of the layout file. Whilst Pretzel is largely compatible with Jekyll it isn&apos;t 100% so. The way it does tags is one of those differences. In Jekyll it seems like it&apos;s a dictionary of tag names to posts. However in Pretzel tags are a list of tag items each of which has the name of the tag and all of the posts for that tag. (&lt;em&gt;Side note: I believe Categories work the same way&lt;/em&gt;). So our copy-pasta&apos;d layout file just isn&apos;t going to cut it.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;h1&amp;gt;Posts by tag {{ page.tag }}&amp;lt;/h1&amp;gt;
&amp;lt;div&amp;gt;
    {% assign HasTag = false %}
    
    {% for tag in site.tags %}
        {% if tag.Name ==  page.tag %}
            {% assign HasTag = true %}
            {% for post in tag.Posts %}
                &amp;lt;p&amp;gt;&amp;lt;a href=&amp;quot;{{ post.url }}&amp;quot;&amp;gt;{{post.title}}&amp;lt;/a&amp;gt;&amp;lt;/p&amp;gt; 
            {% endfor %}
        {% endif %}
    {% endfor %}
    
    {% if HasTag == false %}
        &amp;lt;p&amp;gt;There&apos;s no posts for &amp;quot;{{ page.tag }}&amp;quot;!&amp;lt;/p&amp;gt;
    {% endif %}
&amp;lt;/div&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;First off we&apos;re going to set a variable &lt;code&gt;HasTag&lt;/code&gt; to &lt;code&gt;false&lt;/code&gt;. We&apos;ll then loop through all of the &lt;code&gt;tags&lt;/code&gt; that have been used on our site and compare the &lt;code&gt;Name&lt;/code&gt; to the &lt;code&gt;tag&lt;/code&gt; the user is currently looking at. If they match we set &lt;code&gt;HasTag&lt;/code&gt; to &lt;code&gt;true&lt;/code&gt; and loop through all of the &lt;code&gt;Posts&lt;/code&gt; on the &lt;code&gt;tag&lt;/code&gt; and output a link to the post using it&apos;s title. Finally if &lt;code&gt;HasTag&lt;/code&gt; is still &lt;code&gt;false&lt;/code&gt; we can print out &amp;quot;No tags found&amp;quot; style message. Now let&apos;s try again...&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-08-31-tags/ugly-tagged-posts.png&quot; alt=&quot;It&apos;s ugly, but it works!&quot; title=&quot;It&apos;s ugly, but it works!&quot; /&gt;&lt;/p&gt;
&lt;p&gt;... And it works! It&apos;s not pretty but it&apos;s a list of all my posts. Now why does this look so bland compared to the rest of the posts (not that they&apos;re terribly pretty, but still!). If you snoop about your setup you&apos;ll see there&apos;s &lt;code&gt;_layouts/layout.html&lt;/code&gt; which has all the base styling for your site. When you look at the default &lt;code&gt;_layouts/post.html&lt;/code&gt; you&apos;ll see at the top it has&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-yaml&quot;&gt;---
layout: layout
---
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It might look a little redundant but it&apos;s actually saying &amp;quot;Inherit the &lt;code&gt;layout&lt;/code&gt; for this file from the file stored at &lt;code&gt;_layouts/&lt;/code&gt;&lt;strong&gt;&lt;code&gt;layout&lt;/code&gt;&lt;/strong&gt;&lt;code&gt;.html&lt;/code&gt;&amp;quot;. So, we just need to add a similar tag to our &lt;code&gt;posts_by_tag.html&lt;/code&gt;;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;---
layout: layout
---
&amp;lt;h1&amp;gt;Posts by tag {{ page.tag }}&amp;lt;/h1&amp;gt;
&amp;lt;div&amp;gt;
    {% assign HasTag = false %}
    
    {% for tag in site.tags %}
        {% if tag.Name ==  page.tag %}
            {% assign HasTag = true %}
            {% for post in tag.Posts %}
                &amp;lt;p&amp;gt;&amp;lt;a href=&amp;quot;{{ post.url }}&amp;quot;&amp;gt;{{post.title}}&amp;lt;/a&amp;gt;&amp;lt;/p&amp;gt; 
            {% endfor %}
        {% endif %}
    {% endfor %}
    
    {% if HasTag == false %}
        &amp;lt;p&amp;gt;There&apos;s no posts for &amp;quot;{{ page.tag }}&amp;quot;!&amp;lt;/p&amp;gt;
    {% endif %}
&amp;lt;/div&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-08-31-tags/styled-tagged-posts.png&quot; alt=&quot;Prettier styled posts&quot; title=&quot;Prettier styled posts&quot; /&gt;&lt;/p&gt;
&lt;p&gt;And that&apos;s about it! Have a look through the list of &lt;a href=&quot;http://jekyllrb.com/docs/variables/&quot;&gt;Liquid Variables&lt;/a&gt; for other details you may wish to include on your listing page (such as the &lt;code&gt;post.date&lt;/code&gt;). And finally don&apos;t forget you&apos;ll need to go through and create a corresponding &lt;code&gt;.md&lt;/code&gt; file in &lt;code&gt;tag&lt;/code&gt; for each tag you use on your site. In the future I&apos;ll look at seeing if this is something I can automate as I&apos;m not one for doing something a computer will do much more reliably.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <id>http://domain//technology/2015/08/30/myfirstpost.html</id>
    <link type="text/html" rel="alternate" href="http://domain//technology/2015/08/30/myfirstpost.html"/>
    <title>My First Post</title>
    <updated>2015-08-30T00:00:00+10:00</updated>
    <author>
      <name>Author</name>
      <uri>http://domain/</uri>
    </author>
    <content type="html">&lt;p&gt;Several years ago now Scott Hanselman wrote a blog post titled &lt;a href=&quot;http://www.hanselman.com/blog/YourBlogIsTheEngineOfCommunity.aspx&quot;&gt;Your Blog is the Engine of Community&lt;/a&gt;. The basic premise of it, for those too lazy to read it, was that you should own your own content. Sites like Twitter and Facebook are intrinsically transient and, perhaps more importantly, owned by someone else. &amp;quot;That makes sense!&amp;quot; I thought. And so I had a look about on the internet came across &lt;a href=&quot;https://pages.github.com/&quot;&gt;Github Pages&lt;/a&gt; had a quick play and... forgot about it. And then today a friend of mine was looking at ditching Wordpress for their own blog and asked if I had any suggestions. I gave a half hearted reply about something like &lt;a href=&quot;https://pages.github.com/&quot;&gt;Github Pages&lt;/a&gt; and then... thought about it... and thought I should finally get my act together and finish playing with them myself.&lt;/p&gt;
&lt;p&gt;My initial issue last time I looked into Github Pages was that they run &lt;a href=&quot;http://jekyllrb.com/&quot;&gt;Jekyll&lt;/a&gt;. Which isn&apos;t a bad thing, it&apos;s a nice bit of software, but as a Windows developer it seemed like a bunch of things I&apos;ve only had passing exposure to. I had a look for other static blog engines and came across &lt;a href=&quot;http://code52.org/pretzel.html&quot;&gt;Pretzel&lt;/a&gt;. Like Jekyll Pretzel generates a static blog for you from &lt;a href=&quot;http://daringfireball.net/projects/markdown/&quot;&gt;Markdown&lt;/a&gt; however unlike Jekyll it&apos;s written in .Net and feels more &amp;quot;natural&amp;quot; to a C# developer like myself. I did, however, have a few minor issues along the way, so I figured I&apos;d kill two birds with one stone and write about them.&lt;/p&gt;
&lt;h2&gt;1.  Getting Pretzel&lt;/h2&gt;
&lt;p&gt;Probably the easiest way to grab Pretzel is actually from &lt;a href=&quot;http://chocolatey.org&quot;&gt;Chocolatey&lt;/a&gt;. It&apos;s listed as &lt;a href=&quot;https://chocolatey.org/packages/pretzel&quot;&gt;Pretzel&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This&apos;d be as simple as;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;choco install pretzel
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Personally I grabbed the source code from their &lt;a href=&quot;https://github.com/Code52/pretzel&quot;&gt;Github Page&lt;/a&gt; and built it myself&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;git clone https://github.com/Code52/pretzel
cd pretzel
build.cmd
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After a while you&apos;ll end up with &lt;code&gt;artifacts\Pretzel.exe&lt;/code&gt; which you&apos;ll want to add to your path&lt;/p&gt;
&lt;h2&gt;2.  Setting up your Github Page&lt;/h2&gt;
&lt;p&gt;Github actually has really good documentation on this. The basic premise is you set up a new repository wih the name &lt;code&gt;$YourUsername$.github.io&lt;/code&gt;. Mine, for instance, is &lt;a href=&quot;https://github.com/MrMDavidson/mrmdavidson.github.io&quot;&gt;mrmdavidson.github.io&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;You&apos;ll want to clone this locally, add some content, and push it...&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;git clone https://github.com/MrMDavidson/mrmdavidson.github.io
cd mrmdavidson.github.io
echo &amp;quot;Hello World!&amp;quot; &amp;gt;&amp;gt; index.md
git add index.md
git commit -am &amp;quot;My first page!&amp;quot;
git push
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If you then visit your own &lt;code&gt;$YourUsername$.github.io&lt;/code&gt; you&apos;ll see your &amp;quot;Hello World&amp;quot; page. Hooray!&lt;/p&gt;
&lt;h2&gt;3.  Now let&apos;s make use of Pretzel&lt;/h2&gt;
&lt;p&gt;To get started with Pretzel is actually pretty straight forward. We&apos;re going to jump into the directory we created early and, with Pretzel in our path, tell it to do some things&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;cd mrmdavidson.github.io
pretzel.exe create
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This will create all the infrastructure required for your blog and create a sample post and an &lt;a href=&quot;/about.html&quot;&gt;about&lt;/a&gt; page. But it&apos;s all in MarkDown. How do we use it?&lt;/p&gt;
&lt;p&gt;Pretzel has two main modes &amp;quot;Taste&amp;quot; and &amp;quot;Bake&amp;quot; (Because Pretzels, get it?). Taste allows you to fire everything up locally and test it. Pretzel includes everything needed for this (including an &lt;a href=&quot;http://owin.org/&quot;&gt;Owin&lt;/a&gt; based webserver).&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;pretzel.exe taste -p 8081
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-08-30-myfirstpost/pretzel-tasting.png&quot; alt=&quot;Pretzel Tasting&quot; title=&quot;Pretzel Tasting&quot; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;(You may need to play around with the &lt;code&gt;-p 8081&lt;/code&gt; argument to specify a port that&apos;s currently not in use on your machine)&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;This will also fire up your default browser and show you your newly created blog post. You can play around with the content by editing the file it created in the &lt;code&gt;_posts/&lt;/code&gt; directory.&lt;/p&gt;
&lt;p&gt;Once you get bored of poking at it we&apos;ll commit it and push it to your repository so it can be seen by the world!&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;git add *
git commit -am &amp;quot;My new blog!&amp;quot;
git push
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now visit your own Github Page. Eg. &lt;a href=&quot;http://mrmdavidson.github.io&quot;&gt;mrmdavidson.github.io&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;4.  ... But something isn&apos;t right!&lt;/h2&gt;
&lt;p&gt;For me, at least, I noticed some inconsistencies between what Jekyll generated and what Pretzel generated. This seems like something that&apos;d be horrible to debug. So I poked around a little and found that you can use Github Pages
as a completely static host. You don&apos;t have to have it generate anything with Jekyll. &amp;quot;Interesting&amp;quot;, I thought. How does this work?&lt;/p&gt;
&lt;p&gt;Well, remember earlier how I said Pretzel has two modes? Tasting and Baking? We want the baking mode;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;cd mrmdavidson.github.io
pretzel.exe bake
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;/img/posts/2015-08-30-myfirstpost/pretzel-baking.png&quot; alt=&quot;Pretzel Baking&quot; title=&quot;Pretzel Baking&quot; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Milliseconds later it&apos;ll have finished its work.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Now inside your repository you&apos;ll have an &lt;code&gt;_site&lt;/code&gt; directory. This is a static build of your site (Note: Anything starting with &lt;code&gt;_&lt;/code&gt; is ignored by Jekyll and Pretzel by convention). You can point your browser here and everything should work. But if you push this to your repository it won&apos;t have the desired results. What we&apos;re going to do is place a &amp;quot;.nojekyll&amp;quot; file in our directory - this is an instruction to Github to not run Jekyll on this repository. I know this seems counter intuitive, but trust me.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;echo &amp;quot;&amp;quot; &amp;gt; .nojekyll
git add .nojekyll
git commit -am &amp;quot;Opt out of Jekyll generation&amp;quot;
git push
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now if you visit your lovely blog... it&apos;ll be completely broken. How is this helpful? Stay with me here!&lt;/p&gt;
&lt;p&gt;What we&apos;re going to do is create a new branch. &lt;a href=&quot;https://github.com/MrMDavidson/mrmdavidson.github.io/tree/master&quot;&gt;Master&lt;/a&gt; will be used for the generated content of the site. And our new branch, say, &lt;a href=&quot;https://github.com/MrMDavidson/mrmdavidson.github.io/tree/pretzel&quot;&gt;Pretzel&lt;/a&gt; will be used to store our working blog. This way both our blog &amp;quot;data&amp;quot; and our generated site is under source control.&lt;/p&gt;
&lt;p&gt;To avoid confusion we&apos;ll create two new copies of the repository...&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;git clone https://github.com/MrMDavidson/mrmdavidson.github.io mrmdavidson.github.io-blog
git clone https://github.com/MrMDavidson/mrmdavidson.github.io mrmdavidson.github.io-generated
cd mrmdavidson.github.io-blog
git checkout -B pretzel
git push origin
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now what we&apos;ll do is create blog posts in the &lt;code&gt;mrmdavidson.github.io-blog&lt;/code&gt; directory which pushes to a &amp;quot;Pretzel&amp;quot; branch. Once we&apos;ve finished tasting these we can generate the static content into master. Let&apos;s start by cleaning master. You&apos;ll want to delete from git everything in here but your &lt;code&gt;.nojekyll&lt;/code&gt; file. Once you&apos;ve done that...&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;cd mrmdavidson.github.io-blog
pretzel.exe bake --destination ..\mrmdavidson.github.io-generated\
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The &lt;code&gt;--destination&lt;/code&gt; switch tells Pretzel to generate to a specific, relative-to-current, directory. In this example we&apos;re going to generate to our working copy of the Master branch.&lt;/p&gt;
&lt;p&gt;We can now add everything in here and push to master...&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;cd mrmdavidson.github.io-generated
git add *
git commit -am &amp;quot;Initial generated version of the blog!&amp;quot;
git push origin
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;5. Automating it...&lt;/h2&gt;
&lt;p&gt;That all seems a bit tedious, but repeatable, so what I did was create a &lt;a href=&quot;https://github.com/MrMDavidson/mrmdavidson.github.io/blob/4a609925cfaf57f94a48322c3cc1f7af4acb77bc/generate.bat&quot;&gt;generate.bat&lt;/a&gt; in my Pretzel branch that bakes the blog, adds everything to git, and pushes it to master...&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-dos&quot;&gt;pretzel bake --destination ..\mrmdavidson.github.io-generated\
pushd ..\mrmdavidson.github.io-generated
git add *
git commit -am &amp;quot;Generated site&amp;quot;
git push origin
popd
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This way once I&apos;m finished tasting my blog locally I can just run &lt;code&gt;generate.bat&lt;/code&gt; and seconds later everything is available to the public!&lt;/p&gt;</content>
  </entry>
  
</feed>